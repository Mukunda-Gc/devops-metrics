name: CI-CD Pipeline

on:
  push:
    branches: [ "main" ]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Simulate Build
        run: echo "Building project..."

      - name: Simulate Tests
        run: echo "All tests passed!"

      - name: Security Scan (Simulated)
        run: |
          echo "Scanning code for vulnerabilities..."
          sleep 2
          echo "âœ… No vulnerabilities found in current commit."

      - name: Simulate Deployment
        run: |
          mkdir -p deploy
          cp index.html deploy/
          echo "Deployed successfully."

      - name: Log Deployment Data
        env:
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          RUN_ID: ${{ github.run_id }}
          SHA: ${{ github.sha }}
          COMMIT_TS: ${{ github.event.head_commit.timestamp }}
        run: |
          echo "Logging deployment data..."
          DEPLOY_TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          STATUS=success
          if echo "$COMMIT_MSG" | grep -qi "\[fail\]"; then STATUS=failed; fi
          echo "$RUN_ID,$SHA,$COMMIT_TS,$DEPLOY_TS,$STATUS" >> metrics.csv
          echo "Logged: $RUN_ID,$SHA,$COMMIT_TS,$DEPLOY_TS,$STATUS"

      - name: Commit Updated Metrics
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update metrics log"
          file_pattern: metrics.csv
